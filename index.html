<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Chat SemÃ¢ntico POPs</title>
<style>
body { font-family: Arial; max-width: 700px; margin: 20px auto; }
#chat { border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: auto; }
.msg { margin: 5px 0; white-space: pre-wrap; }
.user { color: blue; }
.bot { color: green; }
input { width: 80%; padding: 5px; }
button { padding: 5px 10px; }
</style>
</head>
<body>
<h2>Chat SemÃ¢ntico - POPs Institucionais</h2>
<div id="chat"></div>
<input type="text" id="pergunta" placeholder="Digite sua pergunta..." />
<button onclick="fazerPergunta()">Enviar</button>

<script>
// ðŸ”¹ Raw link do JSON com embeddings
const popsJSON = "https://raw.githubusercontent.com/Rcs1992/chatfisio/refs/heads/main/pops_embeddings.json";

let pops = [];

// ðŸ”¹ Similaridade coseno
function cosineSim(a,b){
  let dot=0,na=0,nb=0;
  for(let i=0;i<a.length;i++){ dot+=a[i]*b[i]; na+=a[i]*a[i]; nb+=b[i]*b[i]; }
  return dot/(Math.sqrt(na)*Math.sqrt(nb)+1e-9);
}

// ðŸ”¹ Carrega o JSON com embeddings
async function carregarPOPs(){
  const resp = await fetch(popsJSON);
  pops = await resp.json();
  adicionarMensagem("POP(s) carregados com embeddings prontos.", "bot");
}

// ðŸ”¹ FunÃ§Ãµes de chat
function adicionarMensagem(texto,classe){
  const chat = document.getElementById("chat");
  const div = document.createElement("div");
  div.className="msg "+classe;
  div.textContent=texto;
  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
}

function fazerPergunta(){
  const input = document.getElementById("pergunta");
  const pergunta = input.value.trim();
  if(!pergunta) return;
  adicionarMensagem("VocÃª: "+pergunta,"user");
  input.value="";

  adicionarMensagem("Assistente: ... pesquisando ...","bot");

  // ðŸ”¹ Gerar embedding local para a pergunta usando TF.js + MiniLM (ou usar API)
  // Para simplificar e 100% gratuito: vamos usar **busca por palavra-chave** nos chunks
  // Pois embeddings jÃ¡ foram calculados previamente

  let respostas=[];
  const lowerQ = pergunta.toLowerCase();
  for(const pop of pops){
    for(const chunk of pop.chunks){
      if(chunk.texto.toLowerCase().includes(lowerQ)){
        respostas.push(`ðŸ“„ ${pop.titulo}:\n${chunk.texto}`);
      }
    }
  }

  const chatDiv = document.getElementById("chat");
  chatDiv.removeChild(chatDiv.lastChild);

  if(respostas.length>0){
    adicionarMensagem("Assistente: "+respostas.join("\n\n"),"bot");
  } else {
    adicionarMensagem("Assistente: NÃ£o hÃ¡ informaÃ§Ã£o sobre isso nos POPs.","bot");
  }
}

// ðŸ”¹ Inicia carregando os POPs
carregarPOPs();
</script>
</body>
</html>
