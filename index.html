<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Chat Sem√¢ntico POPs</title>
<style>
body { font-family: Arial; max-width: 700px; margin: 20px auto; }
#chat { border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: auto; }
.msg { margin: 5px 0; white-space: pre-wrap; }
.user { color: blue; }
.bot { color: green; }
input { width: 80%; padding: 5px; }
button { padding: 5px 10px; }
</style>
</head>
<body>
<h2>Chat Sem√¢ntico - POPs Institucionais</h2>
<div id="chat"></div>
<input type="text" id="pergunta" placeholder="Digite sua pergunta..." />
<button onclick="fazerPergunta()">Enviar</button>

<script>
const HF_TOKEN = "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"; // seu token HuggingFace
const EMB_MODEL = "sentence-transformers/all-MiniLM-L6-v2";

const popURLs = [
  "https://raw.githubusercontent.com/Rcs1992/chatfisio/refs/heads/main/pops_embeddings.json,
  // adicione os outros POPs aqui
];

let pops = []; // cada pop ter√° {titulo, chunks: [{texto, embedding}]}

// üîπ Fun√ß√£o para dividir texto em chunks
function chunkText(text, size=300){
  let arr=[];
  for(let i=0;i<text.length;i+=size) arr.push(text.slice(i,i+size));
  return arr;
}

// üîπ Gerar embedding usando HuggingFace
async function embedText(text){
  const resp = await fetch(`https://api-inference.huggingface.co/pipeline/feature-extraction/${EMB_MODEL}`,{
    method:"POST",
    headers: {Authorization:`Bearer ${HF_TOKEN}`, "Content-Type":"application/json"},
    body: JSON.stringify({inputs:text})
  });
  const data = await resp.json();
  return data[0];
}

// üîπ Similaridade coseno
function cosineSim(a,b){
  let dot=0,na=0,nb=0;
  for(let i=0;i<a.length;i++){ dot+=a[i]*b[i]; na+=a[i]*a[i]; nb+=b[i]*b[i]; }
  return dot/(Math.sqrt(na)*Math.sqrt(nb)+1e-9);
}

// üîπ Carregar POPs e gerar embeddings
async function carregarPOPs(){
  for(const url of popURLs){
    const resp = await fetch(url);
    const texto = await resp.text();
    const titulo = url.split("/").pop();
    const chunksTexto = chunkText(texto,300);
    const chunks=[];
    for(const c of chunksTexto){
      const emb = await embedText(c);
      chunks.push({texto:c, embedding:emb});
    }
    pops.push({titulo,chunks});
  }
  adicionarMensagem("POP(s) carregados com embeddings em tempo real.", "bot");
}

// üîπ Fun√ß√µes de chat
function adicionarMensagem(texto,classe){
  const chat = document.getElementById("chat");
  const div = document.createElement("div");
  div.className="msg "+classe;
  div.textContent=texto;
  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
}

async function fazerPergunta(){
  const input = document.getElementById("pergunta");
  const pergunta = input.value.trim();
  if(!pergunta) return;
  adicionarMensagem("Voc√™: "+pergunta,"user");
  input.value="";
  adicionarMensagem("Assistente: ... pesquisando ...","bot");

  const qEmb = await embedText(pergunta);
  let best = {score:0,texto:""};
  for(const pop of pops){
    for(const chunk of pop.chunks){
      const sim = cosineSim(qEmb,chunk.embedding);
      if(sim>best.score){
        best={score:sim,texto:`üìÑ ${pop.titulo}:\n${chunk.texto}`};
      }
    }
  }

  const chatDiv = document.getElementById("chat");
  chatDiv.removeChild(chatDiv.lastChild);

  if(best.score>0.6){
    adicionarMensagem("Assistente: "+best.texto,"bot");
  } else {
    adicionarMensagem("Assistente: N√£o h√° informa√ß√£o sobre isso nos POPs.","bot");
  }
}

// Inicia carregando os POPs
carregarPOPs();
</script>
</body>
</html>
